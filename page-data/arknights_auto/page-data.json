{"componentChunkName":"component---src-templates-blog-post-js","path":"/arknights_auto/","result":{"data":{"site":{"siteMetadata":{"title":"NARAZUKE","author":[{"name":"nozzle","summary":"who lives in gummaken.","social":{"github":"nozzlex3"}},{"name":"konnyaku","summary":"who is known as Siege Sukosuko Samurai.","social":{"github":"wabetarou"}}]}},"markdownRemark":{"id":"8b0bb587-893e-51a3-b406-9adfa1316a4b","excerpt":"アークナイツ自動化のツールを作る際の履歴をメモしたもの。 pythonでpyautogui(pyscreeze)を使って作ったがどうやら時に毎回screenshotをとっていて、非効率だしpcに負担かかりそう。なのでせっかくの機会なのでc++を使って新しく自動化機能を作りたいと思う。ちなみに下のコードがpython…","html":"<p>アークナイツ自動化のツールを作る際の履歴をメモしたもの。</p>\n<p>pythonでpyautogui(pyscreeze)を使って作ったがどうやら<code class=\"language-text\">locateOnScreen</code>時に毎回screenshotをとっていて、非効率だしpcに負担かかりそう。なのでせっかくの機会なのでc++を使って新しく自動化機能を作りたいと思う。ちなみに下のコードがpythonで作ったコード。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time<span class=\"token punctuation\">,</span>pyautogui\n\nstart <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nflag <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"秒経過\"</span><span class=\"token punctuation\">)</span>\n    autoPos <span class=\"token operator\">=</span> pyautogui<span class=\"token punctuation\">.</span>locateCenterOnScreen<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/auto.png\"</span><span class=\"token punctuation\">,</span> grayscale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    stageDecidePos <span class=\"token operator\">=</span> pyautogui<span class=\"token punctuation\">.</span>locateCenterOnScreen<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/stage_decide.png\"</span><span class=\"token punctuation\">,</span> grayscale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    stageStartPos <span class=\"token operator\">=</span> pyautogui<span class=\"token punctuation\">.</span>locateCenterOnScreen<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/stage_start.png\"</span><span class=\"token punctuation\">,</span> grayscale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    resultPos <span class=\"token operator\">=</span> pyautogui<span class=\"token punctuation\">.</span>locateCenterOnScreen<span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/result.png\"</span><span class=\"token punctuation\">,</span> grayscale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> autoPos <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        pyautogui<span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span>stageDecidePos<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>stageDecidePos<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click stageDecide\"</span><span class=\"token punctuation\">)</span>\n        flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">elif</span> stageStartPos <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        pyautogui<span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span>stageStartPos<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>stageStartPos<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click stageStart\"</span><span class=\"token punctuation\">)</span>\n        time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">90</span><span class=\"token punctuation\">)</span>\n        flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">elif</span> resultPos <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        pyautogui<span class=\"token punctuation\">.</span>click<span class=\"token punctuation\">(</span>resultPos<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>resultPos<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click result\"</span><span class=\"token punctuation\">)</span>\n        flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        flag <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">if</span> flag <span class=\"token operator\">></span> <span class=\"token number\">20</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">break</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>openCVを動かす</h3>\n<p>いろいろつまづいたが次の手順でやれば良い</p>\n<p>1.Homebrewでインストール</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">brew install opencv\nbrew install pkg-config</code></pre></div>\n<p>2.コードを書く</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;opencv2/opencv.hpp></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n cv<span class=\"token operator\">::</span>Mat img<span class=\"token punctuation\">;</span>\n\n img <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"example.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n cv<span class=\"token operator\">::</span><span class=\"token function\">imshow</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">,</span> img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n cv<span class=\"token operator\">::</span><span class=\"token function\">waitKey</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>3.コンパイル &#x26; 実行</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">g++ -std=c++11 main.cpp `pkg-config --cflags opencv4` `pkg-config --libs opencv4`\n./a.out</code></pre></div>\n<h3>マウスのポジションとクリック</h3>\n<p>CoreGraphics.hをつかいたいが以下のエラーが出る</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Undefined symbols for architecture x86_64:\n  &quot;_CFRelease&quot;, referenced from:\n      _main in main-63de17.o\n  &quot;_CGEventCreate&quot;, referenced from:\n      _main in main-63de17.o\n  &quot;_CGEventGetLocation&quot;, referenced from:\n      _main in main-63de17.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)</code></pre></div>\n<p>このエラーはopencvの場合ではpkg-configを入れることで治った。ヘッダファイルの場所の指定、ライブラリの場所の指定、リンクするライブラリの指定をしているらしい。\n(参考)<a href=\"https://ja.stackoverflow.com/questions/53767/macos-c%E3%81%A7opencv%E3%81%8C%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84\">MacOS c++でopenCVが実行できない</a></p>\n<p>だがCoreGraphicsではpkg-configが使えないため直接オプションを指定する必要がありそうだ。<a href=\"https://stackoverflow.com/questions/18882483/implement-part-of-c-source-code\">https://stackoverflow.com/questions/18882483/implement-part-of-c-source-code</a></p>\n<p>最終的には<code class=\"language-text\">-framework</code>によって無事コンパイルできた。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">g++ -std=c++11 -framework CoreGraphics -framework CoreFoundation main.cpp `pkg-config --cflags opencv4` `pkg-config --libs opencv4`</code></pre></div>\n<p>実際のコードは以下のリンクを参考にした。</p>\n<p>（ポジションについて）<a href=\"https://gist.github.com/mhamilt/7209c809c03e42a7027e9fe5b18fdfa2\">mhamilt/get<em>mouse</em>position_macos.cpp</a><br>\n（クリックについて）<a href=\"https://stackoverflow.com/questions/1483657/performing-a-double-click-using-cgeventcreatemouseevent\">Performing a double click using CGEventCreateMouseEvent()</a></p>\n<h3>画像認識について</h3>\n<p>マウスのポジションを指定してクリックすることはできたので次は指定する画像が存在するか、またどこにあるかを認識できるようにしないといけない。どうしよう。\nOpenCVでそういうことできないか調べた。\n<a href=\"https://qiita.com/anzanshi/items/82fc4c7a3a1f84137aef\">Python OpenCVで画像を検索、判定結果を返してみた</a>\npythonだけど参考になった。どうやら<code class=\"language-text\">matchTemplate</code>が画像の一部が指定の画像と一致するかを判定する関数のようだ。</p>\n<h3>構造体</h3>\n<p>構造体関連でつまづいた。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">main.cpp:120:25: error: member access into incomplete type &#39;struct CGImage&#39;\n    CGFloat cols = image-&gt;width;\n                        ^\n/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/CoreGraphics.framework/Headers/CGImage.h:12:36: note: \n      forward declaration of &#39;CGImage&#39;\ntypedef struct CF_BRIDGED_TYPE(id) CGImage *CGImageRef;\n                                   ^</code></pre></div>\n<p>結局<code class=\"language-text\">CGImageGetWidth()</code>というライブライ関数を使ってどうにかなったけど上のエラーはよくわからないまま。</p>\n<h3>ウィンドウ探索</h3>\n<p>CoreGraphicsでのwindow探索について\n(参考)<a href=\"https://gist.github.com/Recognition101/1e28655eece7f1169951\">Recognition101/appNames.cpp</a></p>\n<h3>CoreGraphics</h3>\n<p>CoreGraphics関連がわからなすぎるのでまとめる。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">func name</th>\n<th align=\"center\">return</th>\n<th align=\"center\">やること</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGMainDisplayID()</code></td>\n<td align=\"center\"><code class=\"language-text\">CGDirectDisplayID</code></td>\n<td align=\"center\">main_displayのIDを返す</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGDisplayBounds(CGDirectDisplayID)</code></td>\n<td align=\"center\"><code class=\"language-text\">CGRect</code></td>\n<td align=\"center\">displayのrectを返す</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGDisplayCreateImage(CGDirectDisplayID)</code></td>\n<td align=\"center\"><code class=\"language-text\">CGImage</code></td>\n<td align=\"center\">cgimageを返す</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGDisplayCreateImage(CGDirectDisplayID, CGRect)</code></td>\n<td align=\"center\"><code class=\"language-text\">CGImage</code></td>\n<td align=\"center\">範囲指定</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGImageGetColorSpace(CGImageRef)</code></td>\n<td align=\"center\"><code class=\"language-text\">CGColorSpaceRef</code></td>\n<td align=\"center\">わからん</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">CGBitmapContextCreate(...)</code></td>\n<td align=\"center\"><code class=\"language-text\">CGContextRef</code></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<p>CoreGraphicsの画像をopencvのMatに変換する関数をつくったがでうまく書き込めず真っ黒になる。。。</p>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\nCoreGraphicsを使う方法を諦めた。諦めたらすっきりした。\n<p>スクリーンショットを<code class=\"language-text\">system()</code>でとる方法に切り替える。</p>\n<h3>構成</h3>\n<p>以下のような順番の構成で自動化ツールを作った。  </p>\n<ol>\n<li>スクリーンショットをとる</li>\n<li>用意した画像が存在するか調べる</li>\n<li>存在する場合、位置を調べる</li>\n<li>その位置をクリックする</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ApplicationServices/ApplicationServices.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;opencv2/opencv.hpp></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;time.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;chrono></span></span>\n\n<span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> std<span class=\"token operator\">::</span>chrono<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">CGPoint</span> CGPoint<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// g++ -std=c++11 -03 -framework CoreGraphics -framework CoreFoundation main.cpp `pkg-config --cflags opencv4` `pkg-config --libs opencv4`</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">click</span><span class=\"token punctuation\">(</span>CGPoint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    clock_t p_start <span class=\"token operator\">=</span> <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> start <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>chrono<span class=\"token operator\">::</span>system_clock<span class=\"token operator\">::</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">double</span> maxVal<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Point maxLoc<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat result<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat screen<span class=\"token punctuation\">;</span>\n    CGPoint location<span class=\"token punctuation\">;</span>\n\n    cv<span class=\"token operator\">::</span>Mat img_auto<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat img_result<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat img_stage_decide<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat img_stage_start<span class=\"token punctuation\">;</span>\n    cv<span class=\"token operator\">::</span>Mat img_line<span class=\"token punctuation\">;</span>\n\n    img_auto <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/auto.png\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    img_result <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/result.png\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    img_stage_decide <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/stage_decide.png\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    img_stage_start <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/stage_start.png\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">double</span> threshold <span class=\"token operator\">=</span> <span class=\"token number\">0.999</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> flag_end <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> flag_click <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"screencapture -x ./image/screenshot.png\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        screen <span class=\"token operator\">=</span> cv<span class=\"token operator\">::</span><span class=\"token function\">imread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./image/screenshot.png\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        cv<span class=\"token operator\">::</span><span class=\"token function\">matchTemplate</span><span class=\"token punctuation\">(</span>screen<span class=\"token punctuation\">,</span> img_auto<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>TM_CCORR_NORMED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cv<span class=\"token operator\">::</span><span class=\"token function\">minMaxLoc</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxVal <span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxVal <span class=\"token operator\">></span> threshold<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">matchTemplate</span><span class=\"token punctuation\">(</span>screen<span class=\"token punctuation\">,</span> img_stage_decide<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>TM_CCORR_NORMED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">minMaxLoc</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxLoc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            location<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n            location<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n            <span class=\"token function\">click</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"clicked stage_desicde\\n\"</span><span class=\"token punctuation\">;</span>\n            flag_click<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>flag_click<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">matchTemplate</span><span class=\"token punctuation\">(</span>screen<span class=\"token punctuation\">,</span> img_stage_start<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>TM_CCORR_NORMED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">minMaxLoc</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxVal <span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxLoc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxVal <span class=\"token operator\">></span> threshold<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                location<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n                location<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n                <span class=\"token function\">click</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"clicked stage_start\\n\"</span><span class=\"token punctuation\">;</span>\n                flag_click<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">90</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>flag_click<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">matchTemplate</span><span class=\"token punctuation\">(</span>screen<span class=\"token punctuation\">,</span> img_result<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> cv<span class=\"token operator\">::</span>TM_CCORR_NORMED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            cv<span class=\"token operator\">::</span><span class=\"token function\">minMaxLoc</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxVal <span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxLoc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxVal <span class=\"token operator\">></span> threshold<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                location<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n                location<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> maxLoc<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n                <span class=\"token function\">click</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"clicked result\\n\"</span><span class=\"token punctuation\">;</span>\n                flag_click<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>flag_click<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            flag_end<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flag_end <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            flag_click <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            flag_end <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">auto</span> end <span class=\"token operator\">=</span> system_clock<span class=\"token operator\">::</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">auto</span> dur <span class=\"token operator\">=</span> end <span class=\"token operator\">-</span> start<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 要した時間を計算</span>\n        <span class=\"token keyword\">auto</span> msec <span class=\"token operator\">=</span> duration_cast<span class=\"token operator\">&lt;</span>milliseconds<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 要した時間をミリ秒（1/1000秒）に変換して表示</span>\n        std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> msec<span class=\"token operator\">/</span><span class=\"token number\">1000.0</span><span class=\"token punctuation\">;</span>\n        clock_t p_end <span class=\"token operator\">=</span> <span class=\"token function\">clock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        std<span class=\"token operator\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>p_end <span class=\"token operator\">-</span> p_start<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> CLOCKS_PER_SEC <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") 秒経過\\n\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">click</span><span class=\"token punctuation\">(</span>CGPoint location<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    CGEventRef event <span class=\"token operator\">=</span> <span class=\"token function\">CGEventCreateMouseEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> kCGEventLeftMouseDown<span class=\"token punctuation\">,</span> location<span class=\"token punctuation\">,</span> kCGMouseButtonLeft<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">CGEventSetIntegerValueField</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> kCGMouseEventClickState<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">CGEventPost</span><span class=\"token punctuation\">(</span>kCGHIDEventTap<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">CGEventSetType</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> kCGEventLeftMouseUp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">CGEventPost</span><span class=\"token punctuation\">(</span>kCGHIDEventTap<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">CFRelease</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>結果</h3>\n<p>前のプログラムより断然早くなった^_^</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 356px; overflow: visible\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/87902347d7c4426824de61967f554029/50ac3/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.27848101265823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACcUlEQVQ4y4VU2XLaQBDUDzg2vjjMfSOBxAohcZrDgAGfieNU/v9HOtNTFkVcFedhajXapZk+Vlbk9dCqteCaPoJwouWaCDe5OuqNLmoND6VKG9W6h1yhiWLZRqFka1+pucgXWyhXO3omfVOF1XUH8Lyh/NDIixqy+aZunF/mkLjI4ttZGmfnN/p8lSzi4iqvxX3W5XXh8I77lmtGGE3WUis07R6cdh+mN0bLCbSfL/eYzrZwOn0FTqbLuE6V/llWEN4i6N9i//iO8XSNnjwvV0+YLXb6fjBa4uHpXffbbqRTfQloehP0o7lM8qBgHS8SHWcCvpF+ikbLx+LuEbuHn4iGS6X+1ZQW6XlCe7V5UeoEJQB70iRdTvf4/EuMcFWrzyDU7gAYDubqZOwa3ao3jepHV+lgTdzmpJ8nO+6T6Q/AZLoiuhRwcpoR0elsTtasGsA6TWS0Tk5TB2dJm8X92HH2dNxqGw+ub2ACg3rLRsN2UG3YMmlHpaARdN4PprBl7XgDuN0hjD9WrcmMbNhn8w1YAz9At+1iPJsjHEzQC0cCFKop1PR2vhUgRshXSUifINSXf3AsSSZbkwmbPmxp1vffsZHa7t7kcKQ/Kn7cCGpDSseBTnzQPA66BtsEEwzHKwF7xXb/A8+vvyWD+8PB+AZ8lb2/YkOdnE6Iu/Uz7ncy5fYVK3nmXf7s5P9KJ6SwMeBu/6ZTrmVaAtHF+K6SXnx3uR5TPWZhMf28x2sJ8kJuC4GZTQpO50oVR0WPmfBLQ0P4JWJeeY77/KDohLSa7tF6OsU1L4GmGa5EhOHmPqNSb3a1JzDdjSNTLDtIZSoK+AcgGdT9kbf5hgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"result\"\n        src=\"/static/87902347d7c4426824de61967f554029/50ac3/result.png\"\n        srcset=\"/static/87902347d7c4426824de61967f554029/c26ae/result.png 158w,\n/static/87902347d7c4426824de61967f554029/6bdcf/result.png 315w,\n/static/87902347d7c4426824de61967f554029/50ac3/result.png 356w\"\n        sizes=\"(max-width: 356px) 100vw, 356px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>一回のループに対して今回のコードでは約0.15sであるのに対して、以前のコードでは約1.4sであるためほぼ10倍早くなっている。</p>\n<p>現在は一つのステージだけを周回するプログラムだが、改良することで基地や任務なども自動化できそうのでいつかやるかもしれない。</p>","fields":{"slug":"/arknights_auto/"},"frontmatter":{"title":"アークナイツ周回の自動化(Mac,C++)","created":"2021-2-4 Thu","updated":"2021-2-10 Wed","description":"C++,openCVを使って自動化","tag":["game","arknights","computer","memo"],"author":["konnyaku"],"index":"9"}},"previous":{"fields":{"slug":"/kon20210204/"},"frontmatter":{"title":"日記"}},"next":{"fields":{"slug":"/blog_service_impression/"},"frontmatter":{"title":"ブログサービス所感"}}},"pageContext":{"index":9,"id":"8b0bb587-893e-51a3-b406-9adfa1316a4b","previousPostId":"d76c8982-5ba3-59be-8e72-b88185d79714","nextPostId":"da720961-74f7-536c-b704-956a29accba2"}},"staticQueryHashes":["3284037645","500847697"]}